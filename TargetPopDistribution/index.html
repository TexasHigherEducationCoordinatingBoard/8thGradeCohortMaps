<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Distribution of Target Populations</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.css' rel='stylesheet' />
  <link href='TargetPopDistribution.css' rel='stylesheet' />
  <style>
   
  </style>
  <script type="text/javascript" src="cohortMapStyle.js"></script>
 
</head>

<body>
    <nav id="menu"></nav>
    
  <div id="map"></div>
  <div class='map-overlay' id='features'><div id='pd'><h3>8th Grade Cohort</h3><p>Hover over a region.</p></div></div>
  <div class='map-overlay legend' id='circleLegend'>
      <h4>Number of Students</h4>
  </div>


     <script type="text/javascript" src="TargetPopDistribution.js"></script>
    
    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9obmRpbm5pbmciLCJhIjoiY2oxazR5NjNvMDFveDJ5b2FzbWZwbjFpbiJ9.bixlFwP8Kf43qHa7Z6XK8g';
    var map = new mapboxgl.Map({
      container: 'map',
      style: cohortStyle,
      center: [-98, 32], //offset to make room for info window
      zoom: 6,
      maxZoom: 15,
      minZoom: 3,
      maxBounds: [[-140, 15], [-60, 45]]
    });

    map.on('load', function () {
      map.addSource('Cohort', {
        'type': 'vector',
        'url': 'mapbox://johndinning.cvggpjmd'
      });
      map.addControl(new mapboxgl.NavigationControl({position:'top-right' }));
      // Disable map rotation using right click + drag
      map.dragRotate.disable();
      // Disable map rotation using touch rotation gesture
      map.touchZoomRotate.disableRotation();
      map.getCanvas().style.cursor = 'default'; //keep pointer
      map.scrollZoom.disable(); //no mousewheel zoom
      addLayerNav(map);
      map.addLayer({
        "id": "AACohoCircle",
        "type": "circle",
        "source": "Cohort",
        "source-layer": "Cohort2006TEARegionPoints",
        "layout": {'visibility': 'visible'},
        paint: {
          'circle-color': '#D49A66',
          // Add data-driven styles for circle radius
          'circle-radius': {
            property: 'AACoho',
            type: 'exponential',
            stops: [
              [{zoom:5, value: 56}, 10],
              [{zoom: 5, value: 28716}, 75],
              [{zoom:8, value: 56}, 20],
              [{zoom: 8, value: 28716}, 150],
            ]
          },
          'circle-opacity': 0.8
        }
      });
      map.addLayer({
        "id": "AACohoNum",
        "type": "symbol",
        "source": "Cohort",
        "source-layer": "Cohort2006TEARegionPoints",
        "layout": {
          // 'visibility': 'visible',
          "text-field": "{AACoho}",
          "text-font": [
            "DIN Offc Pro Medium",
            "Arial Unicode MS Bold"
          ],
          "text-size": 12
        },
        "filter": ['==',"TEAReg", ""]
      }
      );
      map.addLayer({
        "id": "HispCohoCircle",
        "type": "circle",
        "source": "Cohort",
        "source-layer": "Cohort2006TEARegionPoints",
        "layout": {'visibility': 'none'},
        paint: {
          'circle-radius': {
            property: 'HisCoho',
            type: 'exponential',
            stops: [
            [{zoom:5, value: 56}, 8],
            [{zoom: 5, value: 28716}, 60],
            [{zoom:8, value: 56}, 16],
            [{zoom: 8, value: 28716}, 120],
            ]
          },
          'circle-opacity': .8,
          'circle-color': '#D49A66'
        }
      });
      map.addLayer({
        "id": "HispCohoNum",
        "type": "symbol",
        "source": "Cohort",
        "source-layer": "Cohort2006TEARegionPoints",
        "layout": {
          // 'visibility': 'none',
          "text-field": "{HisCoho}",
          "text-font": [
            "DIN Offc Pro Medium",
            "Arial Unicode MS Bold"
          ],
          "text-size": 12
        },
        "filter": ['==',"TEAReg", ""]
      }
      );

      map.addSource("highlight", {
        'type': 'vector',
        'url': 'mapbox://johndinning.cvggpjmd'
      });
    map.addLayer({
      "id": "highlight-hover",
        "type": "fill",
        "source": "highlight",
        'source-layer': 'Cohort2006TEARegionPolys',
        "paint": {
            "fill-color": "#692a85",
            "fill-opacity": .2
    },
        "filter": ['==',"TEAReg", ""]
    });
    
    // By default, exponential property functions have a base of 1.
    // Exponential functions with a base of 1 are linear.
    // The relationship between the radius of any point and the number of pedestrians is:
    // radius = rateOfChange * numberOfPedestrians + radiusAtZero
    var minRadius = 8;
    var maxRadius = 60;
    var minTargetPop = 56;
    var maxTargetPop = 28716;

    // Find the rateOfChange using two points
    var rateOfChange = (maxRadius - minRadius) / (maxTargetPop - minTargetPop);

    // Use the rateOfChange to solve for for radiusAtZero
    // radius = rateOfChange * numberOfPedestrians + radiusAtZero
    var radiusAtZero = maxRadius - (rateOfChange * maxTargetPop);

    var legend = document.getElementById('circleLegend');
    function circleSize(quantile) {
      var radius = (rateOfChange * quantile) + radiusAtZero;
      var diameter = radius * 2;
      return diameter;
    }
    quantiles.forEach(function(quantile){
      legend.insertAdjacentHTML('beforeend', '<div><span style="width:' + circleSize(quantile) + 'px;height:' + circleSize(quantile) + 'px;margin: 0 ' + [(20 - circleSize(quantile)) / 2 ] + 'px"></span><p>' + quantile + '</p></div>');
    });
  });

// For the Info Window
map.on('mousemove', function(e) {
    var region = map.queryRenderedFeatures(
      e.point, {
      layers: ['HispCohoCircle', 'AACohoCircle']
    }
  );

    if ((region.length > 0) && (document.getElementById("menu").firstChild.className=='active')) {
      document.getElementById('pd').innerHTML = '<p><em>There were ' + region[0].properties.TotCoho.toLocaleString() + ' 8th graders in the <strong>' + region[0].properties.RegName + ' Region</strong> public schools in the 2006-2007 school year. By the Spring of 2016, <strong>' + region[0].properties.TotpEnr + '% had enrolled in a Texas college or University.</strong></em></p>';
    } else if ((region.length > 0) && (document.getElementById("menu").lastChild.className=='active')) {
      document.getElementById('pd').innerHTML = '<p><em>There were ' + region[0].properties.TotCoho.toLocaleString() + ' 8th graders in the <strong>' + region[0].properties.RegName + ' Region</strong> public schools in the 2006-2007 school year. By the Spring of 2016, <strong>' + region[0].properties.TotpComp + '% had completed a higher ed degree or certificate in a Texas.</strong></em></p>';
    } else {
      document.getElementById('pd').innerHTML = '<h2>8th Grade Cohort</h2><p>Hover over a region.</p>';
    }
  });

  map.on("mousemove", "AACohoCircle", function(e) {
    map.setFilter("highlight-hover", ["==", "TEAReg", e.features[0].properties["TEAReg"]]);
    map.setFilter("AACohoNum", ["==", "TEAReg", e.features[0].properties["TEAReg"]]);
  });

  map.on("mouseleave", "AACohoCircle", function(e) {
    map.setFilter("highlight-hover", ["==", "TEAReg",""]);
    map.setFilter("AACohoNum", ["==", "TEAReg",""]);
  });

  map.on("mousemove", "HispCohoCircle", function(e) {
    map.setFilter("highlight-hover", ["==", "TEAReg", e.features[0].properties["TEAReg"]]);
    map.setFilter("HispCohoNum", ["==", "TEAReg", e.features[0].properties["TEAReg"]]);
  });

  map.on("mouseleave", "HispCohoCircle", function(e) {
    map.setFilter("highlight-hover", ["==", "TEAReg",""]);
    map.setFilter("HispCohoNum", ["==", "TEAReg", e.features[0].properties["TEAReg"]]);
  });
// </script>
</body>
</html>